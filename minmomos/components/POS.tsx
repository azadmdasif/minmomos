
import React, { useState, useCallback, useEffect } from 'react';
import { TABLES } from '../constants';
import { MenuItem as MenuItemType, OrderItem, OrderType, PaymentMethod, DiningTable } from '../types';
import Menu from './Menu';
import Bill from './Bill';
import VariantSelectionModal from './VariantSelectionModal';
import BillPreviewModal from './BillPreviewModal';
import { saveOrder, peekNextBillNumber, fetchMenuItems } from '../utils/storage';
import { supabase } from '../utils/supabase';
import { printerService } from '../utils/bluetoothPrinter';

const CATEGORIES = [
  { id: 'momo', label: 'Steam & Fried', icon: '‚ô®Ô∏è' },
  { id: 'side', label: 'Sides', icon: 'ü•ó' },
  { id: 'drink', label: 'Drinks', icon: 'ü•§' },
  { id: 'combo', label: 'Combos', icon: 'üç±' }
];

const POS: React.FC<{ branchName: string }> = ({ branchName }) => {
  const [menuItems, setMenuItems] = useState<MenuItemType[]>([]);
  const [order, setOrder] = useState<OrderItem[]>([]);
  const [activeCategory, setActiveCategory] = useState<string>('momo');
  const [selectedItem, setSelectedItem] = useState<MenuItemType | null>(null);
  const [isPreviewing, setIsPreviewing] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [pendingBillNumber, setPendingBillNumber] = useState<number | null>(null);
  const [orderType, setOrderType] = useState<OrderType>('TAKEAWAY');
  const [selectedTable, setSelectedTable] = useState<DiningTable | null>(null);
  const [isTableModalOpen, setIsTableModalOpen] = useState(false);
  const [dbTables, setDbTables] = useState<any[]>([]);
  const [customerPhone, setCustomerPhone] = useState('');
  const [isMobileCartOpen, setIsMobileCartOpen] = useState(false);
  const [isPrinterConnected, setIsPrinterConnected] = useState(false);

  useEffect(() => {
    const loadData = async () => {
      const [mResponse, { data: t }] = await Promise.all([
        fetchMenuItems(),
        supabase.from('dining_tables').select('*')
      ]);
      
      if (mResponse.data) {
        setMenuItems(mResponse.data);
      }
      
      if (t) setDbTables(t);
    };
    loadData();
    setIsPrinterConnected(printerService.isConnected());
  }, [isTableModalOpen]);

  const handleConnectPrinter = async () => {
    const connected = await printerService.connect();
    setIsPrinterConnected(connected);
    if (connected) alert("Printer Connected Successfully!");
  };

  const handleAddItem = useCallback((itemsToAdd: OrderItem[]) => {
    setOrder((prev) => {
      const newOrder = [...prev];
      itemsToAdd.forEach(item => {
        const idx = newOrder.findIndex(i => i.id === item.id);
        if (idx > -1) newOrder[idx].quantity += item.quantity;
        else newOrder.push(item);
      });
      return newOrder;
    });
  }, []);

  const handleUpdateQuantity = (id: string, qty: number) => {
    setOrder(prev => qty <= 0 ? prev.filter(i => i.id !== id) : prev.map(i => i.id === id ? { ...i, quantity: qty } : i));
  };

  const handleFinalize = async () => {
    if (orderType === 'DINE_IN' && !selectedTable) {
      setIsTableModalOpen(true);
      return;
    }
    const nextNum = await peekNextBillNumber();
    setPendingBillNumber(nextNum);
    setIsPreviewing(true);
  };

  const resetAfterOrder = () => {
    setOrder([]);
    setSelectedTable(null);
    setCustomerPhone('');
    setIsPreviewing(false);
    setIsMobileCartOpen(false);
    setPendingBillNumber(null);
  };

  const handleConfirmOrder = async (method: PaymentMethod, useBluetooth: boolean = false) => {
    if (isSaving) return;
    setIsSaving(true);
    
    try {
      const total = order.reduce((acc, i) => acc + i.price * i.quantity, 0);
      const nextBillNum = pendingBillNumber || await peekNextBillNumber();
      
      const savedNum = await saveOrder(
        order, 
        total, 
        branchName, 
        orderType, 
        'ORDERED', 
        method, 
        selectedTable?.id
      );
      
      if (savedNum) {
        if (useBluetooth && printerService.isConnected()) {
          await printerService.printReceipt({
            orderItems: order,
            billNumber: savedNum,
            paymentMethod: method,
            branchName,
            orderType
          });
          resetAfterOrder();
        } else if (!useBluetooth) {
          // SYSTEM PRINT FIX:
          // Register a one-time 'afterprint' listener to reset the state 
          // only after the browser is finished with the print dialog.
          const onAfterPrint = () => {
            resetAfterOrder();
            window.removeEventListener('afterprint', onAfterPrint);
          };
          window.addEventListener('afterprint', onAfterPrint);

          // Trigger print while the receipt is still mounted in the modal
          window.print();
        } else {
            // Case where BT print requested but printer not connected
            resetAfterOrder();
        }
      }
    } catch (err) {
      console.error(err);
      alert("An error occurred while finalizing the order.");
    } finally {
      setIsSaving(false);
    }
  };

  const handleTableSelect = (table: DiningTable) => {
    if (table.status === 'AVAILABLE') {
      setSelectedTable(table);
      setIsTableModalOpen(false);
    }
  };

  const filteredItems = menuItems.filter(item => item.category === activeCategory);

  return (
    <div className="flex flex-col lg:flex-row h-full bg-brand-cream pb-20 lg:pb-0">
      {/* Category Picker */}
      <div className="w-full lg:w-32 bg-white border-b lg:border-r border-stone-200 flex lg:flex-col p-3 gap-3 shadow-sm z-10 overflow-x-auto lg:overflow-visible no-scrollbar">
        <div className="hidden lg:block text-[10px] font-black uppercase text-stone-400 tracking-widest text-center mb-2">Menu</div>
        {CATEGORIES.map(cat => (
          <button
            key={cat.id}
            onClick={() => setActiveCategory(cat.id)}
            className={`flex flex-col items-center justify-center min-w-[80px] lg:min-w-0 aspect-square p-2 rounded-2xl transition-all duration-300 border-2 shrink-0 ${
              activeCategory === cat.id ? 'bg-brand-yellow border-brand-yellow text-brand-brown shadow-lg' : 'bg-white border-stone-100 text-stone-400 hover:border-brand-yellow/30'
            }`}
          >
            <span className="text-lg lg:text-xl mb-1">{cat.icon}</span>
            <span className="text-[8px] lg:text-[9px] font-black uppercase tracking-tighter text-center leading-none">{cat.label}</span>
          </button>
        ))}
      </div>

      {/* Item Grid */}
      <div className="flex-1 overflow-y-auto p-4 lg:p-6 no-scrollbar">
        <div className="max-w-5xl mx-auto">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 lg:mb-8 gap-4">
             <div>
                <h2 className="text-2xl lg:text-3xl font-black text-brand-brown tracking-tighter italic uppercase leading-none">Local <span className="text-brand-red">Favorites</span></h2>
                <p className="text-[8px] lg:text-[10px] font-bold text-stone-400 uppercase tracking-widest mt-1">Flavor Station: {branchName}</p>
             </div>
             <div className="flex gap-2 w-full sm:w-auto items-center">
               {printerService.isSupported() && (
                 <button 
                  onClick={handleConnectPrinter}
                  className={`flex items-center gap-2 px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-widest transition-all ${isPrinterConnected ? 'bg-mountain-green text-white' : 'bg-brand-stone text-brand-brown'}`}
                 >
                   <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M14.88 12L19 7.88 15.12 4h-1.41v6.29L10.41 7 9 8.41 12.59 12 9 15.59 10.41 17l3.29-3.29V20h1.41L19 16.12 14.88 12zM15.71 7l1.29 1.29L15.71 9.58V7zm0 10V14.42l1.29 1.29L15.71 17zM7 12c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2z"/></svg>
                   {isPrinterConnected ? 'BT Ready' : 'Connect Printer'}
                 </button>
               )}

               {orderType === 'DINE_IN' && (
                 <button 
                  onClick={() => setIsTableModalOpen(true)}
                  className="flex-1 sm:flex-none px-4 py-2 bg-brand-yellow text-brand-brown rounded-full text-[9px] font-black uppercase tracking-widest shadow-lg"
                 >
                   {selectedTable ? `Table ${selectedTable.number}` : 'Select Table'}
                 </button>
               )}
             </div>
          </div>
          <Menu menuItems={filteredItems} onSelectItem={setSelectedItem} />
        </div>
      </div>

      {/* Cart Sidebar */}
      <div className="hidden lg:flex w-96 bg-brand-brown border-l border-brand-brown/10 flex-col shadow-2xl relative z-10">
        <div className="p-4 border-b border-white/5 bg-brand-brown/90">
          <div className="flex bg-black/20 p-1 rounded-2xl mb-4">
            {(['DINE_IN', 'TAKEAWAY', 'DELIVERY'] as OrderType[]).map(type => (
              <button
                key={type}
                onClick={() => {
                  setOrderType(type);
                  if (type !== 'DINE_IN') setSelectedTable(null);
                }}
                className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all duration-200 ${
                  orderType === type ? 'bg-brand-yellow text-brand-brown shadow-md scale-[1.02]' : 'text-brand-cream/40 hover:text-brand-cream/60'
                }`}
              >
                {type.replace('_', ' ')}
              </button>
            ))}
          </div>
          
          <div className="space-y-2">
            <label className="text-[10px] font-black uppercase text-brand-cream/40 tracking-[0.2em]">Customer Contact</label>
            <input 
              type="tel"
              placeholder="Enter Phone Number..."
              value={customerPhone}
              onChange={(e) => setCustomerPhone(e.target.value)}
              className="w-full bg-white/10 border border-white/10 rounded-xl p-3 text-sm font-bold text-brand-cream outline-none focus:border-brand-yellow transition-colors placeholder:text-white/20"
            />
          </div>
        </div>
        
        <div className="flex-1 overflow-hidden">
          <Bill 
            orderItems={order} 
            onUpdateQuantity={handleUpdateQuantity} 
            onClear={() => { setOrder([]); setSelectedTable(null); setCustomerPhone(''); }} 
            onPreview={handleFinalize}
            branchName={branchName}
            onAddItem={handleAddItem}
          />
        </div>
      </div>

      {/* Mobile Cart Overlay */}
      <button 
        onClick={() => setIsMobileCartOpen(true)}
        className={`lg:hidden fixed bottom-24 right-6 w-16 h-16 bg-brand-red rounded-full shadow-2xl flex items-center justify-center text-white z-40 transition-transform active:scale-95 ${order.length > 0 ? 'scale-100' : 'scale-0'}`}
      >
        <span className="absolute -top-1 -right-1 bg-brand-yellow text-brand-brown w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black border-2 border-brand-red">
          {order.reduce((acc, i) => acc + i.quantity, 0)}
        </span>
        <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
        </svg>
      </button>

      {isMobileCartOpen && (
        <div className="lg:hidden fixed inset-0 bg-brand-brown z-50 flex flex-col animate-in slide-in-from-bottom duration-300">
          <div className="p-6 border-b border-white/10 flex justify-between items-center">
            <button onClick={() => setIsMobileCartOpen(false)} className="text-white/40">
              <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div className="text-center">
              <h3 className="text-xl font-black text-brand-yellow uppercase italic">Your <span className="text-white">Cart</span></h3>
              <p className="text-[8px] font-bold text-white/30 uppercase tracking-[0.2em]">{orderType.replace('_', ' ')}</p>
            </div>
            <div className="w-8 h-8"></div>
          </div>
          
          <div className="flex-1 overflow-hidden">
            <Bill 
              orderItems={order} 
              onUpdateQuantity={handleUpdateQuantity} 
              onClear={() => { setOrder([]); setSelectedTable(null); setCustomerPhone(''); setIsMobileCartOpen(false); }} 
              onPreview={handleFinalize}
              branchName={branchName}
              onAddItem={handleAddItem}
            />
          </div>
        </div>
      )}

      {isTableModalOpen && (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-[100] p-4">
          <div className="bg-brand-cream rounded-[2rem] lg:rounded-[3rem] shadow-2xl w-full max-w-4xl p-6 lg:p-10 overflow-hidden flex flex-col max-h-[90vh]">
            <div className="flex justify-between items-center mb-6 lg:mb-8">
              <h3 className="text-2xl lg:text-3xl font-black text-brand-brown italic uppercase">Seating <span className="text-brand-red">Plan</span></h3>
              <button onClick={() => setIsTableModalOpen(false)} className="text-brand-brown/40 hover:text-brand-brown transition-colors">
                <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6" /></svg>
              </button>
            </div>
            <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 overflow-y-auto no-scrollbar">
              {TABLES.map(table => {
                const dbTable = dbTables.find(dt => dt.id === table.id);
                const status = dbTable?.status || 'AVAILABLE';
                return (
                  <button key={table.id} disabled={status !== 'AVAILABLE'} onClick={() => handleTableSelect({ ...table, status })} className={`aspect-square rounded-2xl lg:rounded-3xl p-4 flex flex-col items-center justify-center border-4 transition-all ${selectedTable?.id === table.id ? 'bg-brand-yellow border-brand-yellow text-brand-brown' : status === 'AVAILABLE' ? 'bg-white border-brand-stone text-brand-brown' : 'bg-stone-200 border-stone-300 text-stone-400'}`}>
                    <span className="text-2xl lg:text-3xl font-black">{table.number}</span>
                    <span className="text-[8px] font-bold uppercase tracking-widest mt-1">{status}</span>
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      )}

      <VariantSelectionModal item={selectedItem} onClose={() => setSelectedItem(null)} onAddItem={handleAddItem} />
      <BillPreviewModal 
        isOpen={isPreviewing} 
        onClose={() => setIsPreviewing(false)} 
        onConfirm={handleConfirmOrder} 
        orderItems={order}
        billNumber={pendingBillNumber}
        branchName={branchName}
        onAddItem={handleAddItem}
        onUpdateQuantity={handleUpdateQuantity}
        isSaving={isSaving}
        orderType={orderType}
        tableId={selectedTable?.id}
        customerPhone={customerPhone}
        isPrinterConnected={isPrinterConnected}
      />
    </div>
  );
};

export default POS;
